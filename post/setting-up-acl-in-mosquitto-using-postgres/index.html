<!doctype html>







































<html
  class="not-ready lg:text-base"
  style="--bg: #fff"
  lang="en-us"
>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  
  <title>Setting up ACL in Mosquitto using Postgres - Kiran Gangadharan</title>

  
  <meta name="theme-color" />

  
  
  
  
  <meta name="description" content="Lately, I&rsquo;ve been playing around with Mosquitto and MQTT in general. Something that is essential to prevent unauthorized access to topics is some sort of an access control mechanism. In this post, I&rsquo;ll illustrate the necessary steps for setting up an ACL(Access Control List) using Postgres and mosquitto-auth-plugin.
Install Dependencies sudo apt-get install libc-ares-dev libcurl4-openssl-dev uuid-dev postgresql libpq-dev git Install Mosquitto Download Mosquitto from source:
wget http://mosquitto.org/files/source/mosquitto-1.4.1.tar.gz Build it from source:" />
  <meta name="author" content="Kiran Gangadharan" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="http://kirang.in/main.min.css" />

  
  
  
  
  
  <link rel="preload" as="image" href="http://kirang.in/theme.svg" />

  
  
  
  
  

  
  
  <link rel="preload" as="image" href="http://kirang.in/twitter.svg" />
  
  <link rel="preload" as="image" href="http://kirang.in/github.svg" />
  
  <link rel="preload" as="image" href="http://kirang.in/linkedin.svg" />
  
  <link rel="preload" as="image" href="http://kirang.in/rss.svg" />
  
  

  
  
  <script
    defer
    src="http://kirang.in/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
  
  

  
  <link rel="icon" href="http://kirang.in/favicon_32x32.png" />
  <link rel="apple-touch-icon" href="http://kirang.in/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.126.1">

  
  
  
  
  


  
  
  <meta itemprop="name" content="Setting up ACL in Mosquitto using Postgres">
  <meta itemprop="description" content="Lately, I’ve been playing around with Mosquitto and MQTT in general. Something that is essential to prevent unauthorized access to topics is some sort of an access control mechanism. In this post, I’ll illustrate the necessary steps for setting up an ACL(Access Control List) using Postgres and mosquitto-auth-plugin.
Install Dependencies sudo apt-get install libc-ares-dev libcurl4-openssl-dev uuid-dev postgresql libpq-dev git Install Mosquitto Download Mosquitto from source:
wget http://mosquitto.org/files/source/mosquitto-1.4.1.tar.gz Build it from source:">
  <meta itemprop="datePublished" content="2015-05-23T00:00:00+05:30">
  <meta itemprop="dateModified" content="2015-05-23T00:00:00+05:30">
  <meta itemprop="wordCount" content="486">
  <meta itemprop="keywords" content="Mosquitto,Postgres,Mqtt">
  
  <meta property="og:url" content="http://kirang.in/post/setting-up-acl-in-mosquitto-using-postgres/">
  <meta property="og:site_name" content="Kiran Gangadharan">
  <meta property="og:title" content="Setting up ACL in Mosquitto using Postgres">
  <meta property="og:description" content="Lately, I’ve been playing around with Mosquitto and MQTT in general. Something that is essential to prevent unauthorized access to topics is some sort of an access control mechanism. In this post, I’ll illustrate the necessary steps for setting up an ACL(Access Control List) using Postgres and mosquitto-auth-plugin.
Install Dependencies sudo apt-get install libc-ares-dev libcurl4-openssl-dev uuid-dev postgresql libpq-dev git Install Mosquitto Download Mosquitto from source:
wget http://mosquitto.org/files/source/mosquitto-1.4.1.tar.gz Build it from source:">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2015-05-23T00:00:00+05:30">
    <meta property="article:modified_time" content="2015-05-23T00:00:00+05:30">
    <meta property="article:tag" content="Mosquitto">
    <meta property="article:tag" content="Postgres">
    <meta property="article:tag" content="Mqtt">

  
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Setting up ACL in Mosquitto using Postgres">
  <meta name="twitter:description" content="Lately, I’ve been playing around with Mosquitto and MQTT in general. Something that is essential to prevent unauthorized access to topics is some sort of an access control mechanism. In this post, I’ll illustrate the necessary steps for setting up an ACL(Access Control List) using Postgres and mosquitto-auth-plugin.
Install Dependencies sudo apt-get install libc-ares-dev libcurl4-openssl-dev uuid-dev postgresql libpq-dev git Install Mosquitto Download Mosquitto from source:
wget http://mosquitto.org/files/source/mosquitto-1.4.1.tar.gz Build it from source:">

  
  
  
  <link rel="canonical" href="http://kirang.in/post/setting-up-acl-in-mosquitto-using-postgres/" />
  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[4.5rem] max-w-3xl px-8 lg:justify-center">
  <div class="relative z-50 mr-auto flex items-center">
    <a
      class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold"
      href="http://kirang.in/"
      >Kiran Gangadharan</a
    >
    <div
      class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.svg)_left_center/cover_no-repeat] dark:invert dark:[background-position:right]"
      role="button"
      aria-label="Dark"
    ></div>
  </div>

  <div
    class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
    role="button"
    aria-label="Menu"
  ></div>

  

  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = '#fff'.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    if (htmlClass.contains('dark')) {
      setDark(true);
    } else {
      const darkVal = localStorage.getItem('dark');
      setDark(darkVal ? darkVal === 'true' : darkScheme.matches);
    }

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    

    
    <nav
      class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-12 lg:mt-0 lg:items-center lg:space-x-6"
    >
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./twitter.svg)"
        href="https://twitter.com/kirang89"
        target="_blank"
        rel="me"
      >
        twitter
      </a>
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./github.svg)"
        href="https://github.com/kirang89"
        target="_blank"
        rel="me"
      >
        github
      </a>
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./linkedin.svg)"
        href="https://linkedin.com/in/kirang89"
        target="_blank"
        rel="me"
      >
        linkedin
      </a>
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./rss.svg)"
        href="http://kirang.in/index.xml"
        target="_blank"
        rel="alternate"
      >
        rss
      </a>
      
    </nav>
    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-3xl px-8 pb-16 pt-12 dark:prose-invert"
    >
      

<article>
  <header class="mb-16">
    <h1 class="!my-0 pb-2.5">Setting up ACL in Mosquitto using Postgres</h1>

    
    <div class="text-sm antialiased opacity-60">
      
      <time>May 23, 2015</time>
      
      
      
      
      <span class="mx-1">&middot;</span>
      <span>Kiran Gangadharan</span>
      
    </div>
    
  </header>

  <section><p>Lately, I&rsquo;ve been playing around with Mosquitto and MQTT in
general. Something that is essential to prevent unauthorized access to
topics is some sort of an access control mechanism. In this post, I&rsquo;ll
illustrate the necessary steps for setting up an ACL(Access Control
List) using Postgres and <a href="https://github.com/jpmens/mosquitto-auth-plug.git">mosquitto-auth-plugin</a>.</p>
<h2 id="install-dependenciesa-idsec-1-namesec-1a">Install Dependencies<!-- raw HTML omitted --><!-- raw HTML omitted --></h2>
<pre><code>sudo apt-get install libc-ares-dev libcurl4-openssl-dev uuid-dev postgresql libpq-dev git
</code></pre>
<h2 id="install-mosquittoa-idsec-2-namesec-2a">Install Mosquitto<!-- raw HTML omitted --><!-- raw HTML omitted --></h2>
<p>Download Mosquitto from source:</p>
<pre><code>wget http://mosquitto.org/files/source/mosquitto-1.4.1.tar.gz
</code></pre>
<p>Build it from source:</p>
<pre><code>tar xvzf mosquitto-1.4.1.tar.gz
cd mosquitto-1.4.1
</code></pre>
<p>Set <code>WITH_SRV:=NO</code> in config.mk to deal with
<a href="https://github.com/jpmens/mosquitto-auth-plug/issues/33">this</a>.</p>
<p>Now we&rsquo;re all set to build Mosquitto:</p>
<pre><code>make mosquitto
sudo make install
</code></pre>
<h2 id="setup-the-authentication-plugina-idsec-3-namesec-3a">Setup the Authentication plugin<!-- raw HTML omitted --><!-- raw HTML omitted --></h2>
<pre><code>git clone https://github.com/jpmens/mosquitto-auth-plug.git
cd mosquitto-auth-plug
cp config.mk.in config.mk
</code></pre>
<p>Edit the configuration file to match the following:</p>
<pre><code># Select your backends from this list
BACKEND_CDB ?= no
BACKEND_MYSQL ?= no
BACKEND_SQLITE ?= no
BACKEND_REDIS ?= no
BACKEND_POSTGRES ?= yes
BACKEND_LDAP ?= no
BACKEND_HTTP ?= no
BACKEND_MONGO ?= no

# Specify the path to the Mosquitto sources here
MOSQUITTO_SRC = /path/to/mosquitto-1.4.1

# Specify the path the OpenSSL here
OPENSSLDIR = /usr
</code></pre>
<p>Build the plugin:</p>
<pre><code>make
</code></pre>
<p>Finally, move the generated plugin file to the root directory of Mosquitto:</p>
<pre><code>mv auth-plug.so /etc/mosquitto/
</code></pre>
<h2 id="setup-mosquitto-with-the-plugina-idsec-4-namesec-4a">Setup Mosquitto with the plugin<!-- raw HTML omitted --><!-- raw HTML omitted --></h2>
<p>Add the following lines to <code>mosquitto.conf</code>:</p>
<pre><code>auth_opt_backends postgres
auth_plugin /etc/mosquitto/auth-plug.so
auth_opt_host &lt;host&gt;
auth_opt_port &lt;port&gt;
auth_opt_dbname &lt;dbname&gt;
auth_opt_userquery SELECT password FROM account WHERE username = $1 limit 1
auth_opt_superquery SELECT COALESCE(COUNT(*),0) FROM account WHERE username = $1 AND super = 1
auth_opt_aclquery SELECT topic FROM acls WHERE (username = $1) AND (rw &gt;= $2)
</code></pre>
<p>See the <a href="https://github.com/jpmens/mosquitto-auth-plug#postgresql">plugin documentation</a> for more options.</p>
<p>Next, create the necessary tables:</p>
<pre><code>create table account(
id SERIAL,
username TEXT NOT NULL,
password TEXT,
super smallint DEFAULT 0 NOT NULL,
PRIMARY KEY (id)
);

CREATE INDEX account_username ON account (username);

CREATE TABLE acls (
id SERIAL,
username TEXT NOT NULL,
topic TEXT NOT NULL,
rw INTEGER NOT NULL DEFAULT 0,
PRIMARY KEY (id)
);

CREATE UNIQUE INDEX acls_user_topic ON acls (username, topic);
</code></pre>
<p><em>Note: The password will stored as a PBKDF2 hash. There are a few
<a href="https://github.com/jpmens/mosquitto-auth-plug/tree/master/contrib">tools</a> to help you generate the required hash.</em></p>
<h2 id="testing-broker-with-the-new-configurationa-idsec-5-namesec-5a">Testing broker with the new configuration<!-- raw HTML omitted --><!-- raw HTML omitted --></h2>
<p>Once you&rsquo;ve completed adding the necessary configuration and tables,
it&rsquo;s time to finally test them out! To do so, start Mosquitto with the
configuration file:</p>
<pre><code>/usr/local/sbin/mosquitto -c /etc/mosquitto/mosquitto.conf
</code></pre>
<p>If everything goes well, you should see the following output from the
broker:</p>
<pre><code>1432149665: |-- *** auth-plug: startup
1432149665: |-- ** Configured order: postgres

1432149665: |-- }}}} POSTGRES
1432149665: |-- HERE: SELECT COALESCE(COUNT(*),0) FROM account WHERE username = $1 AND super = 1
1432149665: |-- HERE: SELECT topic FROM acls WHERE (username = $1) AND (rw &gt;= $2)
</code></pre>
<p>You should now be able to connect to this broker by setting the
username and password fields of your mqtt client. Even though the
PBKDF2 hash of the password is stored in the database, you can provide
the raw password while connecting.</p>
<p>Hope this helps.</p>
<p><strong>UPDATE</strong>: Added minor changes to deal with errors when starting Mosquitto</p>
</section>

  
  
  <footer class="mt-12 flex flex-wrap">
     
    <a
      class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]"
      href="http://kirang.in/tags/mosquitto"
      >mosquitto</a
    >
     
    <a
      class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]"
      href="http://kirang.in/tags/postgres"
      >postgres</a
    >
     
    <a
      class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]"
      href="http://kirang.in/tags/mqtt"
      >mqtt</a
    >
    
  </footer>
  

  
  
  
  
  <nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]">
    
    <a
      class="flex w-1/2 items-center rounded-l-md p-6 pr-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]"
      href="http://kirang.in/post/cs-reading-computer-programming-as-an-art/"
      ><span class="mr-1.5">←</span><span>CS Reading: Computer Programming as an Art</span></a
    >
    
    
    <a
      class="ml-auto flex w-1/2 items-center justify-end rounded-r-md p-6 pl-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]"
      href="http://kirang.in/post/emacs-as-email-client-with-offlineimap-and-mu4e-on-osx/"
      ><span>Emacs as email client with offlineimap and mu4e on OS X</span><span class="ml-1.5">→</span></a
    >
    
  </nav>
  
  

  
  
  <div class="mt-24" id="disqus_thread"></div>
  <script>
    const disqusShortname = 'kirangin';
    const script = document.createElement('script');
    script.src = 'https://' + disqusShortname + '.disqus.com/embed.js';
    script.setAttribute('data-timestamp', +new Date());
    document.head.appendChild(script);
  </script>
  

  
  

  


  
</article>


    </main>

    <footer
  class="opaco mx-auto flex h-[4.5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"
>
  <div class="mr-auto">
    &copy; 2024
    <a class="link" href="http://kirang.in/">Kiran Gangadharan</a>
  </div>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank"
    >Powered by Hugo️️</a
  >️
  <a
    class="link"
    href="https://github.com/nanxiaobei/hugo-paper"
    rel="noopener"
    target="_blank"
    >✎ Paper</a
  >
</footer>

  </body>
</html>
